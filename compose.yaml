services:
  auth:
    image: ghcr.io/ionaru/deals/auth:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/service.Dockerfile
      args:
        - SERVICE_NAME=auth
    environment:
      - AUTH_DB_URL
      - AUTH_DB_NAME
      - NATS_HOST=nats
    depends_on:
      nats:
        condition: service_healthy
    restart: no

  gateway:
    image: ghcr.io/ionaru/deals/gateway:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/service.Dockerfile
      args:
        - SERVICE_NAME=gateway
    ports:
      - "3333:3333"
    environment:
      - AUTH_DB_URL
      - SESSION_DB_NAME
      - GATEWAY_SESSION_NAME
      - GATEWAY_SESSION_SECRET
      - NATS_HOST=nats
    depends_on:
      nats:
        condition: service_healthy
    restart: no
    healthcheck:
      test: 'wget --header="Accept: text/html" localhost:3333/graphql -q --spider'

  client:
    image: ghcr.io/ionaru/deals/client:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/client.Dockerfile
    ports:
      - "${DEALS_CLIENT_PORT:-80}:80"
    depends_on:
      gateway:
        condition: service_healthy
    restart: no

  scrapers-jumbo:
    image: ghcr.io/ionaru/deals/scrapers-jumbo:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/service.Dockerfile
      args:
        - SERVICE_NAME=scrapers/jumbo
    environment:
      - NATS_HOST=nats
    depends_on:
      nats:
        condition: service_healthy
    restart: no

  scrapers-kruidvat:
    image: ghcr.io/ionaru/deals/scrapers-kruidvat:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/service.Dockerfile
      args:
        - SERVICE_NAME=scrapers/kruidvat
    environment:
      - NATS_HOST=nats
    depends_on:
      nats:
        condition: service_healthy
    restart: no

  storage:
    image: ghcr.io/ionaru/deals/storage:${DEALS_BUILD_TAG:-latest}
    build:
      context: .
      dockerfile: deploy/service.Dockerfile
      args:
        - SERVICE_NAME=storage
    environment:
      - STORAGE_DB_NAME
      - STORAGE_DB_CA
      - STORAGE_DB_CRT
      - STORAGE_DB_KEY
      - STORAGE_DB_HOST
      - STORAGE_DB_PASS
      - STORAGE_DB_PORT
      - STORAGE_DB_USER
      - STORAGE_DB_SSL
      - STORAGE_DB_SYNCHRONIZE
      - NATS_HOST=nats
    depends_on:
      nats:
        condition: service_healthy
    restart: no

  nats:
    image: nats:2-alpine
    healthcheck:
      test: "wget localhost:8222/healthz -q --spider"
